<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
    .note-text, .todo-text, .action-text, .curiosity-text {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: monospace;
    }
    .separator {
        border-top: 1px solid #4b5563;
        margin: 0.5rem 0;
    }
    body {
        margin: 0;
        overflow: hidden; /* Prevent page scrolling */
        height: 100vh; /* Full height */
        width: 100vw; /* Full width */
    }/* Custom focus styles for buttons */
    button:focus {
        outline: 4px solid yellow;
    }
    /* Optional: Highlight active tab button */
    button[aria-pressed="true"] {
        background-color: #3b82f6; /* Tailwind blue-500 */
        color: white;
    }
    /* Modal styles */
    #query-modal {
        z-index: 1000; /* Ensure modal is above other content */
    }
    /* Modal styles */
    #query-modal, #filter-modal {
        z-index: 1000; /* Ensure modals are above other content */
    }
    #query-modal .bg-white, #filter-modal .bg-white {
        max-height: 90vh; /* Increase modal height to 90% of viewport */
        min-height: 400px; /* Ensure minimum height for taller modal */
        overflow-y: auto; /* Scroll if content overflows */
    }
    #query-response h3 {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    /* Style for empty datetime inputs */
    .empty-datetime {
        border-color: #d1d5db; /* Tailwind gray-300 */
        background-color: #f3f4f6; /* Tailwind gray-100 */
        color: #6b7280; /* Tailwind gray-500 */
    }
    .empty-datetime:focus {
        background-color: #ffffff; /* White background on focus */
        color: #1f2937; /* Tailwind gray-900 */
    }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex flex-col min-h-screen max-h-screen p-4">
        <!-- Header (Title and Tabs) -->
        <div class="bg-white p-4 shadow-sm flex flex-col">
            <div class="flex flex-row justify-between m-0 p-0" >
                <button tabindex="5" id="query-modal-button" aria-label="Open Query Modal" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 focus:ring-2 focus:ring-blue-500">Query</button>
                <h1 class="text-2xl font-bold text-center text-gray-800">Planner</h1>
                <button id="filter-modal-button" aria-label="Open Filter Modal" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 focus:ring-2 focus:ring-blue-500">Filter</button>
            </div>
            <div class="flex mt-4 space-x-1">
                <button tabindex="1" id="notes-button" onclick="showTab('notes')" aria-label="View Notes" aria-pressed="true" class="flex-1 bg-blue-500 text-white p-2 hover:bg-blue-600 focus:ring-2 focus:ring-blue-500">Notes</button>
                <button tabindex="2" id="todos-button" onclick="showTab('todos')" aria-label="View Todos" aria-pressed="false" class="flex-1 bg-white text-blue-500 p-2 hover:bg-blue-600 focus:ring-2 focus:ring-blue-500">Todos</button>
                <button tabindex="3" id="actions-button" onclick="showTab('actions')" aria-label="View Actions" aria-pressed="false" class="flex-1 bg-white text-blue-500 p-2 hover:bg-blue-600 focus:ring-2 focus:ring-blue-500">Actions</button>
                <button tabindex="4" id="curiosities-button" onclick="showTab('curiosities')" aria-label="View Curiosities" aria-pressed="false" class="flex-1 bg-white text-blue-500 p-2 hover:bg-blue-600 focus:ring-2 focus:ring-blue-500">Curiosities</button>
            </div>
        </div>
        <!-- Middle Panel (Tabs for Todos, Notes, Actions, Curiosities) -->
        <div id="middle-panel" class="bg-white p-4 rounded shadow grow h-max overflow-auto">
            <div id="middle-content" class="text-sm text-gray-800"></div>
        </div>
        <!-- Note Input (Bottom) -->
        <div class="mt-4 flex gap-2">
            <input tabindex="0" id="note-input" type="text" placeholder="Enter new note" class="flex-1 p-2 border rounded-l border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="add-note-button" onclick="createNote()" aria-label="Add New Note" class="bg-blue-500 text-white p-2 rounded-r hover:bg-blue-600 focus:ring-2 focus:ring-blue-500">Add Note</button>
        </div>
    </div>
    <!-- Query Modal -->
    <div id="query-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden" role="dialog" aria-labelledby="modal-title" aria-modal="true">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md relative">
            <button id="modal-close-button" aria-label="Close Query Modal" class="absolute top-2 left-2 text-gray-600 hover:text-gray-800 focus:ring-2 focus:ring-blue-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <h2 id="modal-title" class="text-lg font-bold mb-4 ml-8">Query</h2>
            <div class="flex gap-2 mb-4">
                <input id="query-input" type="text" placeholder="query your notes" class="flex-1 p-2 border rounded-l border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Query input">
                <button id="query-submit-button" aria-label="Submit Query" class="bg-blue-500 text-white p-2 rounded-r hover:bg-blue-600 focus:ring-2 focus:ring-blue-500">Submit</button>
            </div>
            <div id="query-response" class="text-sm text-gray-800 p-2 border rounded max-h-400 overflow-auto" aria-live="polite"></div>
        </div>
    </div>
    <!-- Filter Modal -->
    <div id="filter-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden" role="dialog" aria-labelledby="filter-modal-title" aria-modal="true">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg relative">
            <button id="filter-modal-close-button" aria-label="Close Filter Modal" class="absolute top-2 left-2 text-gray-600 hover:text-gray-800 focus:ring-2 focus:ring-blue-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <h2 id="filter-modal-title" class="text-lg font-bold mb-4 ml-8">Filter</h2>
            <!-- Common Filters -->
            <div class="mb-4">
                <label for="filter-search" class="block text-sm font-medium text-gray-700">Search</label>
                <input id="filter-search" type="text" placeholder="Search text" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Search filter">
            </div>
            <div class="flex gap-2 mb-4">
                <div class="flex-1">
                    <label for="filter-start-time" class="block text-sm font-medium text-gray-700">Start Time</label>
                    <input id="filter-start-time" type="datetime-local" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Start time filter" aria-describedby="filter-start-time-hint">
                    <p id="filter-start-time-hint" class="text-xs text-gray-500 mt-1">Select start time (e.g., 2025-04-20 00:00)</p>
                </div>
                <div class="flex-1">
                    <label for="filter-end-time" class="block text-sm font-medium text-gray-700">End Time</label>
                    <input id="filter-end-time" type="datetime-local" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="End time filter" aria-describedby="filter-end-time-hint">
                    <p id="filter-end-time-hint" class="text-xs text-gray-500 mt-1">Select end time (e.g., 2025-04-20 23:59)</p>
                </div>
            </div>
            <!-- Notes-Specific Filter -->
            <div id="notes-filter" class="mb-4 hidden">
                <label for="filter-category" class="block text-sm font-medium text-gray-700">Category</label>
                <input id="filter-category" type="text" placeholder="Enter category" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Category filter">
            </div>
            <!-- Actions-Specific Filter -->
            <div id="actions-filter" class="mb-4 hidden">
                <label class="flex items-center">
                    <input id="filter-applied-to-todo" type="checkbox" class="h-4 w-4 text-blue-500 rounded focus:ring-2 focus:ring-blue-500" aria-label="Applied to Todo filter">
                    <span class="ml-2 text-sm text-gray-700">Applied to a Todo</span>
                </label>
            </div>
            <!-- Todos-Specific Filters -->
            <div id="todos-filter" class="mb-4 hidden">
                <label class="flex items-center mb-2">
                    <input id="filter-completed" type="checkbox" checked class="h-4 w-4 text-blue-500 rounded focus:ring-2 focus:ring-blue-500" aria-label="Completed todos filter">
                    <span class="ml-2 text-sm text-gray-700">Completed</span>
                </label>
                <label class="flex items-center mb-2">
                    <input id="filter-cancelled" type="checkbox" class="h-4 w-4 text-blue-500 rounded focus:ring-2 focus:ring-blue-500" aria-label="Cancelled todos filter">
                    <span class="ml-2 text-sm text-gray-700">Cancelled</span>
                </label>
                <label class="flex items-center">
                    <input id="filter-active" type="checkbox" checked class="h-4 w-4 text-blue-500 rounded focus:ring-2 focus:ring-blue-500" aria-label="Active todos filter">
                    <span class="ml-2 text-sm text-gray-700">Active</span>
                </label>
            </div>
            <div class="flex gap-2">
                <button id="filter-apply-button" aria-label="Apply Filters" class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 focus:ring-2 focus:ring-blue-500">Apply</button>
                <button id="filter-clear-button" aria-label="Clear Filters" class="flex-1 bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400 focus:ring-2 focus:ring-blue-500">Clear</button>
            </div>
        </div>
    </div>
    <!-- Templates (unchanged) -->
    <template id="note-template">
        <div class="note-item bg-gray-100 p-1 rounded-md shadow-sm mb-1">
            <div class="note-header flex items-center space-x-1">
                <span class="note-id font-bold text-sm"></span>
                <span class="note-timestamp text-sm text-gray-600"></span>
                <span class="text-sm">-</span>
                <span class="note-category text-blue-500 text-sm"></span>
            </div>
            <div class="note-error text-red-500 text-xs leading-tight" style="display: none;"></div>
            <div class="note-text-content mt-0.5 text-sm leading-tight"></div>
            <div class="separator"></div>
        </div>
    </template>
    <template id="todo-template">
        <div class="todo-item bg-gray-100 p-1 rounded-md shadow-sm flex items-center space-x-1 mb-1 hover:bg-gray-200">
            <input type="checkbox" class="todo-checkbox h-4 w-4 text-green-500 rounded focus:ring-0" disabled>
            <div class="flex-1">
                <div class="todo-main text-sm font-medium leading-tight"></div>
                <div class="todo-details text-xs text-gray-500 leading-tight"></div>
            </div>
        </div>
    </template>
    <template id="action-template">
        <div class="action-item bg-gray-100 p-1 rounded-md shadow-sm mb-1">
            <div class="action-header flex items-center space-x-1">
                <span class="action-id font-bold text-sm"></span>
                <span class="action-timestamp text-sm text-gray-600"></span>
            </div>
            <div class="action-text-content ml-2 mt-0.5 text-sm leading-tight"></div>
            <div class="separator"></div>
        </div>
    </template>
    <template id="curiosity-template">
        <div class="curiosity-item bg-gray-100 p-1 rounded-md shadow-sm mb-1">
            <div class="curiosity-timestamp font-bold text-sm"></div>
            <div class="curiosity-note-text mt-0.5 text-sm leading-tight"></div>
            <div class="curiosity-annotation-text ml-2 mt-0.5 text-sm leading-tight"></div>
            <div class="separator"></div>
        </div>
    </template>

    <script>
        // Global filter variables
        let filterValues = {
            search: '',
            startTime: '',
            endTime: '',
            notes: { category: '' },
            actions: { appliedToTodo: false },
            todos: { completed: true, cancelled: false, active: true }
        };
        console.log('rendering with filter values:', filterValues);

        // Filter Modal logic
        const filterModal = document.getElementById('filter-modal');
        const filterModalButton = document.getElementById('filter-modal-button');
        const filterModalCloseButton = document.getElementById('filter-modal-close-button');
        const filterApplyButton = document.getElementById('filter-apply-button');
        const filterClearButton = document.getElementById('filter-clear-button');
        const filterSearch = document.getElementById('filter-search');
        const filterStartTime = document.getElementById('filter-start-time');
        const filterEndTime = document.getElementById('filter-end-time');
        const filterCategory = document.getElementById('filter-category');
        const filterAppliedToTodo = document.getElementById('filter-applied-to-todo');
        const filterCompleted = document.getElementById('filter-completed');
        const filterCancelled = document.getElementById('filter-cancelled');
        const filterActive = document.getElementById('filter-active');

        // Show/hide tab-specific filters
        function updateFilterModal() {
            document.getElementById('notes-filter').classList.toggle('hidden', currentTab !== 'notes');
            document.getElementById('actions-filter').classList.toggle('hidden', currentTab !== 'actions');
            document.getElementById('todos-filter').classList.toggle('hidden', currentTab !== 'todos');
            // Populate fields with current filter values
            filterSearch.value = filterValues.search;
            filterStartTime.value = filterValues.startTime || '';
            filterEndTime.value = filterValues.endTime || '';
            filterCategory.value = filterValues.notes.category;
            filterAppliedToTodo.checked = filterValues.actions.appliedToTodo;
            filterCompleted.checked = filterValues.todos.completed;
            filterCancelled.checked = filterValues.todos.cancelled;
            filterActive.checked = filterValues.todos.active;
            // Apply visual indicator for empty values
            filterStartTime.classList.toggle('empty-datetime', !filterValues.startTime);
            filterEndTime.classList.toggle('empty-datetime', !filterValues.endTime);
        }

        // Open filter modal
        function openFilterModal() {
            updateFilterModal();
            filterModal.classList.remove('hidden');
            filterSearch.focus(); // Focus search input for accessibility
        }

        // Close filter modal
        function closeFilterModal() {
            filterModal.classList.add('hidden');
            filterModalButton.focus(); // Return focus to trigger button
        }

        // Apply filters
        function applyFilters() {
            filterValues.search = filterSearch.value.trim();
            filterValues.startTime = filterStartTime.value;
            filterValues.endTime = filterEndTime.value;
            filterValues.notes.category = filterCategory.value.trim();
            filterValues.actions.appliedToTodo = filterAppliedToTodo.checked;
            filterValues.todos.completed = filterCompleted.checked;
            filterValues.todos.cancelled = filterCancelled.checked;
            filterValues.todos.active = filterActive.checked;
            fetchTabContent();
            closeFilterModal();
        }

        function applyFilterOnEnter(event) {
            // apply filters on enter
            if (event.key === 'Enter') {
                event.preventDefault();
                applyFilters();
            }
        }

        filterSearch.addEventListener('input', applyFilterOnEnter);
        filterStartTime.addEventListener('input', applyFilterOnEnter);
        filterEndTime.addEventListener('input', applyFilterOnEnter);
        filterCategory.addEventListener('input', applyFilterOnEnter);
        filterAppliedToTodo.addEventListener('input', applyFilterOnEnter);
        filterCompleted.addEventListener('input', applyFilterOnEnter);
        filterCancelled.addEventListener('input', applyFilterOnEnter);
        filterActive.addEventListener('input', applyFilterOnEnter);


        // Clear filters
        function clearFilters() {
            filterValues = {
                search: '',
                startTime: '',
                endTime: '',
                notes: { category: '' },
                actions: { appliedToTodo: false },
                todos: { completed: true, cancelled: false, active: true }
            };
            filterSearch.value = '';
            filterStartTime.value = '';
            filterEndTime.value = '';
            filterCategory.value = '';
            filterAppliedToTodo.checked = false;
            filterCompleted.checked = true;
            filterCancelled.checked = false;
            filterActive.checked = true;
            // Reset visual indicators
            filterStartTime.classList.add('empty-datetime');
            filterEndTime.classList.add('empty-datetime');
            fetchTabContent();
            closeFilterModal();
        }

        // Open modal on button click
        filterModalButton.addEventListener('click', openFilterModal);

        // Close modal on close button click
        filterModalCloseButton.addEventListener('click', closeFilterModal);

        // Apply filters on button click
        filterApplyButton.addEventListener('click', applyFilters);

        // Clear filters on button click
        filterClearButton.addEventListener('click', clearFilters);

        // Close modal on Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !filterModal.classList.contains('hidden')) {
                closeFilterModal();
            }
        });

        // Close modal when clicking outside
        filterModal.addEventListener('click', (event) => {
            if (event.target === filterModal) {
                closeFilterModal();
            }
        });

        // Hotkey for opening filter modal (Cmd/Ctrl + F)
        document.addEventListener('keydown', (event) => {
            if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === 'f') {
                event.preventDefault();
                openFilterModal();
            }
        });

        // Query modal logic
        const queryModal = document.getElementById('query-modal');
        const queryModalButton = document.getElementById('query-modal-button');
        const queryInput = document.getElementById('query-input');
        const queryResponse = document.getElementById('query-response');
        const querySubmitButton = document.getElementById('query-submit-button');
        const modalCloseButton = document.getElementById('modal-close-button');

        // Open modal
        function openQueryModal() {
            queryModal.classList.remove('hidden');
            queryInput.focus(); // Focus input for accessibility
        }

        // Close modal
        function closeQueryModal() {
            queryModal.classList.add('hidden');
            queryModalButton.focus(); // Return focus to trigger button
        }

        // Open modal on button click
        queryModalButton.addEventListener('click', openQueryModal);

        // Close modal on close button click
        modalCloseButton.addEventListener('click', closeQueryModal);

        // Close modal on Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !queryModal.classList.contains('hidden')) {
                closeQueryModal();
            }
        });

        // Close modal when clicking outside
        queryModal.addEventListener('click', (event) => {
            if (event.target === queryModal) {
                closeQueryModal();
            }
        });

        // Handle query submission
        async function submitQuery() {
            const query = queryInput.value.trim();
            if (!query) {
                queryResponse.innerHTML = '<p class="text-red-500">Please enter a query</p>';
                return;
            }
            try {
                queryResponse.innerHTML = '<p>Processing query...</p>';
                const response = await fetch(`/api/summary?prompt=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.error) {
                    queryResponse.innerHTML = `<p class="text-red-500">Error: ${data.error}</p>`;
                } else {
                    // Display the response, convert from the list of strings to a series of paragraphs
                    const paragraphs = data.summary.map(paragraph => `<p>${paragraph}</p>`).join('');
                    queryResponse.innerHTML = `<h3>Response:</h3>${paragraphs}`;
                }
            } catch (error) {
                queryResponse.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }

        // Submit query on button click
        querySubmitButton.addEventListener('click', submitQuery);

        // Submit query on Enter key in input
        queryInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitQuery();
            }
        });

        // rendering logic
        let currentTab = 'notes';

        // Hotkey listener for Cmd/Ctrl/opt + key
        document.addEventListener('keydown', (event) => {
            if ((event.metaKey || event.ctrlKey || event.altKey) && !event.shiftKey) {
                const key = event.key.toLowerCase();
                let targetButton;

                switch (key) {
                    case 'n': // Cmd/Ctrl + N for Notes
                        event.preventDefault();
                        targetButton = document.getElementById('notes-button');
                        showTab('notes');
                        break;
                    case 't': // Cmd/Ctrl + T for Todos
                        event.preventDefault();
                        targetButton = document.getElementById('todos-button');
                        showTab('todos');
                        break;
                    case 'a': // Cmd/Ctrl + A for Actions
                        event.preventDefault();
                        targetButton = document.getElementById('actions-button');
                        showTab('actions');
                        break;
                    case 'c': // Cmd/Ctrl + C for Curiosities
                        event.preventDefault();
                        targetButton = document.getElementById('curiosities-button');
                        showTab('curiosities');
                        break;
                    case 'q': // Cmd/Ctrl + Q for Query
                        event.preventDefault();
                        targetButton = document.getElementById('query-modal-button');
                        openQueryModal();
                        break;
                    case 'enter': // Cmd/Ctrl + Enter for focus the note text box
                        event.preventDefault();
                        // focus the note input box, or the query input box if the modal is open
                        const modalOpen = !queryModal.classList.contains('hidden');
                        targetInput = modalOpen ? queryInput : document.getElementById('note-input');
                        targetInput.focus();
                        break;
                }

                // Focus the button for visual feedback
                if (targetButton) {
                    targetButton.focus();
                }
            }
        });

        function showTab(tab) {
            currentTab = tab;
            document.getElementById('middle-content').innerHTML = '';

            // Update aria-pressed and styles for tab buttons
            const buttons = ['notes-button', 'todos-button', 'actions-button', 'curiosities-button'];
            buttons.forEach((btnId) => {
                const btn = document.getElementById(btnId);
                if (btnId === `${tab}-button`) {
                    btn.classList.remove('bg-white', 'text-blue-500');
                    btn.classList.add('bg-blue-500', 'text-white');
                    btn.setAttribute('aria-pressed', 'true');
                } else {
                    btn.classList.add('bg-white', 'text-blue-500');
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.setAttribute('aria-pressed', 'false');
                }
            });

            fetchTabContent();
        }

        function formatParagraph(text, width = 75, indents = 1) {
            const space = width - 8 * indents;
            let prettyText = '';
            if (text.length > space) {
                prettyText += '    '.repeat(indents) + text.slice(0, space) + '\n';
                let remainder = text.slice(space);
                while (remainder) {
                    if (remainder.length > space) {
                        prettyText += '    '.repeat(indents) + remainder.slice(0, space) + '\n';
                        remainder = remainder.slice(space);
                    } else {
                        prettyText += '    '.repeat(indents) + remainder + '\n';
                        remainder = '';
                    }
                }
            } else {
                prettyText += '    '.repeat(indents) + text + '\n';
            }
            return prettyText;
        }

        function formatDateTime(date, include_year = false) {
            // if it is an empty string or nullish, return an empty string
            if (!date) return '';
            // Ensure input is a Date object
            const d = date instanceof Date ? date : new Date(date);
            
            // Extract UTC components
            const year = d.getUTCFullYear();
            const month = String(d.getUTCMonth() + 1).padStart(2, '0'); // Months are 0-based
            const day = String(d.getUTCDate()).padStart(2, '0');
            const hours = String(d.getUTCHours()).padStart(2, '0');
            const minutes = String(d.getUTCMinutes()).padStart(2, '0');
            const seconds = String(d.getUTCSeconds()).padStart(2, '0');
            
            // Return formatted string
            if (include_year) {
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }
            return `${month}-${day} ${hours}:${minutes}:${seconds}`;
        }        

        function formatDateTimeFromUTC(date, include_year = false) {
            // Ensure input is a Date object
            const d = date instanceof Date ? date : new Date(date);
            
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0'); // Months are 0-based
            const day = String(d.getDate()).padStart(2, '0');
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const seconds = String(d.getSeconds()).padStart(2, '0');
            
            // Return formatted string
            if (include_year) {
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }
            return `${month}-${day} ${hours}:${minutes}:${seconds}`;
        }        

        function renderNote(note) {
            const template = document.getElementById('note-template').content.cloneNode(true);
            const item = template.querySelector('.note-item');
            item.querySelector('.note-id').textContent = `[${String(note.id).padStart(4, '0')}]`;
            item.querySelector('.note-timestamp').textContent = formatDateTime(note.timestamp)
            item.querySelector('.note-category').textContent = note.category ? note.category.name : 'Uncategorized';
            if (note.processing_error) {
                const errorDiv = item.querySelector('.note-error');
                errorDiv.textContent = `Error: ${note.processing_error}`;
                errorDiv.style.display = 'block';
            }
            item.querySelector('.note-text-content').textContent = formatParagraph(note.processed_note_text || note.note_text);
            return item;
        }

        function renderTodo(todo) {
            const template = document.getElementById('todo-template').content.cloneNode(true);
            const item = template.querySelector('.todo-item');
            const checkbox = item.querySelector('.todo-checkbox');
            checkbox.checked = todo.complete;
            let mainText = `[${String(todo.id).padStart(4, '0')}]: ${todo.todo_text}`;
            let detailsText = '';
            if (todo.target_start_time || todo.target_end_time) {
                detailsText += `${formatDateTime(todo.target_start_time) || '*'} -> ${formatDateTime(todo.target_end_time) || '*'}`;
            }
            const created = todo.source_annotation?.note?.timestamp || '';
            if (created) detailsText += `${detailsText ? ' | ' : ''}Created: ${formatDateTime(created)}`;
            if (todo.complete && todo.source_annotation?.note?.timestamp) {
                detailsText += `${detailsText ? ' | ' : ''}Done: ${formatDateTime(todo.source_annotation.note.timestamp)}`;
            }
            const now = new Date();
            const startTime = todo.target_start_time ? new Date(todo.target_start_time) : null;
            const endTime = todo.target_end_time ? new Date(todo.target_end_time) : null;
            const started = startTime && startTime < now;
            const late = endTime && endTime < now;
            const yellow = started && !late;
            const red = late;
            const green = todo.complete;
            const grey = todo.cancelled;
            const white = !started && !endTime;
            let colorClass = 'text-gray-800';
            if (green) colorClass = 'text-green-500';
            else if (grey) colorClass = 'text-gray-400';
            else if (red) colorClass = 'text-red-500';
            else if (yellow) colorClass = 'text-yellow-500';
            else if (white) colorClass = 'text-gray-800';
            else colorClass = 'text-pink-500';
            item.classList.add(colorClass);
            item.querySelector('.todo-main').textContent = mainText;
            item.querySelector('.todo-details').textContent = detailsText;
            return item;
        }

        function renderAction(action) {
            const template = document.getElementById('action-template').content.cloneNode(true);
            const item = template.querySelector('.action-item');
            let actionText = action.action_text;
            if (action.todo_id && action.todo) {
                actionText += ` -> ${action.todo.todo_text}`;
            }
            item.classList.add(action.mark_complete ? 'text-green-500' : 'text-gray-800');
            item.querySelector('.action-id').textContent = `[${String(action.id).padStart(4, '0')}]`;
            item.querySelector('.action-timestamp').textContent = formatDateTime(action.start_time);
            item.querySelector('.action-text-content').textContent = actionText;
            return item;
        }

        function renderCuriosity(curiosity) {
            const template = document.getElementById('curiosity-template').content.cloneNode(true);
            const item = template.querySelector('.curiosity-item');
            item.querySelector('.curiosity-timestamp').textContent = formatDateTime(curiosity.note.timestamp);
            item.querySelector('.curiosity-note-text').textContent = formatParagraph(curiosity.note.note_text, 75, 0);
            item.querySelector('.curiosity-annotation-text').textContent = formatParagraph(curiosity.annotation_text, 75, 1);
            return item;
        }

        async function fetchTabContent() {
            try {
                const endpoint = currentTab === 'curiosities' ? '/api/curiosities' : `/api/${currentTab}`;
                console.log('Fetching data from:', endpoint, 'with filters:', filterValues);
                // Build query parameters
                const params = new URLSearchParams();
                params.append('limit', '50');
                if (filterValues.search) params.append('search', filterValues.search);
                if (filterValues.startTime) params.append('startTime', formatDateTimeFromUTC(filterValues.startTime, true));
                if (filterValues.endTime) params.append('endTime', formatDateTimeFromUTC(filterValues.endTime, true));
                if (currentTab === 'notes' && filterValues.notes.category) {
                    params.append('category', filterValues.notes.category);
                }
                if (currentTab === 'actions' && filterValues.actions.appliedToTodo) {
                    params.append('hasTodo', 'true');
                }
                if (currentTab === 'todos') {
                    params.append('completed', Boolean(filterValues.todos.completed));
                    params.append('cancelled', Boolean(filterValues.todos.cancelled));
                    params.append('active', Boolean(filterValues.todos.active));
                }
                console.log('Fetching data with params:', params.toString());
                const response = await fetch(`${endpoint}?${params.toString()}`, {
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                const contentDiv = document.getElementById('middle-content');
                contentDiv.innerHTML = '';
                let items = [];
                if (currentTab === 'notes') {
                    items = (data.notes || []).map(note => renderNote(note));
                } else if (currentTab === 'todos') {
                    items = (data.todos || []).map(todo => renderTodo(todo));
                } else if (currentTab === 'actions') {
                    items = (data.actions || []).map(action => renderAction(action));
                } else if (currentTab === 'curiosities') {
                    items = (data.curiosities || []).reverse().map(curiosity => renderCuriosity(curiosity));
                }
                if (items.length === 0) {
                    contentDiv.textContent = `No ${currentTab} found`;
                } else {
                    items.forEach(item => contentDiv.appendChild(item));
                }
                // Scroll to the bottom of the container
                const scrollContainer = document.getElementById('middle-panel');
                scrollContainer.scrollTop = scrollContainer.scrollHeight;
            } catch (error) {
                document.getElementById('middle-content').textContent = `Error: ${error.message}`;
            }
        }

        async function createNote() {
            const noteInput = document.getElementById('note-input');
            const noteText = noteInput.value.trim();
            if (!noteText) {
                alert('Please enter a note');
                return;
            }
            try {
                const response = await fetch('/api/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { note: noteText } })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                noteInput.value = '';
                if (currentTab === 'notes') fetchTabContent();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Initial data fetch
        showTab('notes');

        // Add Enter event listener to the text box
        document.getElementById('note-input').addEventListener('keypress', function (event) {
            if (event.key === 'Enter' && !event.metaKey && !event.ctrlKey) {
                event.preventDefault();
                createNote();
            }
        });
    </script>
</body>
</html>
